# 메세지큐를 직접 써볼거임.

1. MySQL + Kafka

> Debezium은 H2 데이터베이스와 RabbitMQ를 지원하지 않음...

```bash
docker compose up -d
```

## TODO

- Outbox
  - Outbox 패턴을 적용해서, 트랜잭션이 성공하면 메시지를 발행하는 구조로 만들기
  - (별도의 테이블을 만들어서, 메시지를 저장하고, CDC로 RabbitMQ로 발행하는 구조)

## 만드려는 것 : 회원가입

- 회원가입에 성공하면,
  - 사용자에게 메일 보내고, (SMTP, JavaMailSender)
  - 이벤트성 쿠폰을 발급하고,
  - 사용자 증감 통계 갱신 이벤트 발행 (될진 모르겠지만 : 이건 여러개 쌓여도 하나만 발행되도록)

## 비교

- HEAD : 99614f0812d31db7d4594c781003e4c334c1236e
  - 그냥 단순하게 구현한 구조.
  - 장점
    - 부담 없이 구현 가능
  - 단점
    - 회원가입 성공이후 메일 발송, 쿠폰 발급 모두 동기적으로 처리됨. (API 응답이 너무 느림. avg 3~4초)
    - 회원가입은 성공해도, 이메일발송(외부 API)이 실패하면 회원가입이 실패함.
      - 이말은 즉슨 외부 서비스의 장애가 우리 서비스의 장애로 이어질 수 있다는 것.
    - 코드가 지저분해질 수 있음
      - 인증인가 패키지에 이메일 발송, 쿠폰 발급 코드가 섞여 있음.

- HEAD : cc1e58c4ce28ffb47bd12d33b1b8acf7ba15b328
  - 회원가입 이후 이메일 발송, 쿠폰 발급을 RabbitMQ로 메시지 발행해서 처리하는 구조.
  - 장점
    - 단순함.
    - 인증 패키지에 이메일 발송, 쿠폰 발급 관련 코드가 import 되지 않음.
    - 회원가입 성공 이후, 이메일 발송, 쿠폰 발급 모두 비동기로 처리됨. (API 응답이 빨라짐. avg 0.1초)
  - 단점
    - 이벤트가 발행되지 않는 경우가 발생할 수 있음.
      - 예를 들어, RabbitMQ가 다운되거나, 네트워크 이슈로 메시지가 발행되지 않는 경우.
      - 이런 경우엔 데이터 정합성이 깨질 수 있음.
